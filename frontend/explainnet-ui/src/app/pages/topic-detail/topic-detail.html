<div class="topic-detail-container">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <p>Loading topic details...</p>
  </div>

  <!-- Topic Content -->
  <div *ngIf="!isLoading && topicData" class="topic-content">
    <!-- Header Section -->
    <div class="topic-header">
      <button mat-icon-button (click)="goBackToLocker()" class="back-button">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="topic-info">
        <h1>{{topicData.topic_name}}</h1>
        <div class="topic-stats">
          <span class="stat-item">{{topicData.article_count}} Articles</span>
          <span class="stat-item">{{topicData.video_count}} Videos</span>
        </div>
      </div>
    </div>

    <!-- Tabbed Content -->
    <mat-tab-group class="topic-tabs" (selectedTabChange)="onTabChange($event)">
      <mat-tab label="YouTube Analytics">
        <div class="tab-content">
          <!-- Video Timeline Visualization -->
          <div class="analytics-section">
            <h2>Video Performance Timeline</h2>
            <div class="chart-controls">
              <div class="control-row">
                <div class="chart-info">
                  <h3>ðŸ“Š Individual Video Performance</h3>
                  <p>Click on any bar to open the video on YouTube</p>
                </div>
              </div>
              
              <div class="filter-controls">
                <mat-form-field appearance="outline" class="filter-field">
                  <mat-label>Videos to Show</mat-label>
                  <mat-select [(value)]="channelLimit" (selectionChange)="updateChart()">
                    <mat-option value="1">1 Video</mat-option>
                    <mat-option value="2">2 Videos</mat-option>
                    <mat-option value="3">3 Videos</mat-option>
                    <mat-option value="4">4 Videos</mat-option>
                    <mat-option value="5">5 Videos</mat-option>
                    <mat-option value="6">6 Videos</mat-option>
                    <mat-option value="7">7 Videos</mat-option>
                    <mat-option value="8">8 Videos</mat-option>
                    <mat-option value="9">9 Videos</mat-option>
                    <mat-option value="10">10 Videos</mat-option>
                  </mat-select>
                </mat-form-field>
                
                <mat-form-field appearance="outline" class="filter-field">
                  <mat-label>Sort By</mat-label>
                  <mat-select [(value)]="sortBy" (selectionChange)="updateChart()">
                    <mat-option value="views_desc">Views (High to Low)</mat-option>
                    <mat-option value="views_asc">Views (Low to High)</mat-option>
                    <mat-option value="name_asc">Channel Name (A-Z)</mat-option>
                    <mat-option value="name_desc">Channel Name (Z-A)</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
            </div>
            <mat-card class="chart-card">
              <mat-card-content>
                <div class="chart-container">
                  <canvas id="timelineChart" width="800" height="400"></canvas>
                </div>
              </mat-card-content>
            </mat-card>
          </div>

          <!-- Channel Impact Scores -->
          <div class="analytics-section">
            <h2>Channel Impact Rankings</h2>
            <div class="channel-cards" *ngIf="channelAnalytics.length > 0">
              <mat-card class="channel-card" *ngFor="let channel of channelAnalytics.slice(0, 5)">
                <mat-card-header>
                  <mat-card-title>{{channel.channel_name}}</mat-card-title>
                  <mat-card-subtitle>Impact Score: {{channel.impact_score}}</mat-card-subtitle>
                </mat-card-header>
                <mat-card-content>
                  <div class="channel-stats">
                    <div class="stat">
                      <strong>{{channel.total_views | number}}</strong>
                      <span>Total Views</span>
                    </div>
                    <div class="stat">
                      <strong>{{channel.total_videos}}</strong>
                      <span>Videos</span>
                    </div>
                    <div class="stat">
                      <strong>{{channel.sentiment_analysis.overall_score | number:'1.1-1'}}%</strong>
                      <span>Sentiment</span>
                    </div>
                  </div>
                  <div class="sentiment-breakdown">
                    <span class="positive">+{{channel.sentiment_analysis.positive}}</span>
                    <span class="neutral">={{channel.sentiment_analysis.neutral}}</span>
                    <span class="negative">-{{channel.sentiment_analysis.negative}}</span>
                    <small>
                      {{channel.sentiment_analysis.analyzed_comments || channel.sentiment_analysis.english_comments}} analyzed 
                      / {{channel.sentiment_analysis.total_comments}} total
                    </small>
                  </div>
                  <div class="language-info" *ngIf="channel.sentiment_analysis.non_english_comments > 0">
                    <small>{{channel.sentiment_analysis.non_english_comments}} non-English comments detected</small>
                  </div>
                </mat-card-content>
              </mat-card>
            </div>
          </div>
        </div>
      </mat-tab>

      <mat-tab label="News Analytics">
        <div class="tab-content">
          <!-- News Source Reliability Section -->
          <div class="analytics-section">
            <h2>News Source Reliability</h2>
            <div class="reliability-cards" *ngIf="newsReliability.length > 0">
              <mat-card class="reliability-card" *ngFor="let source of newsReliability">
                <mat-card-header>
                  <mat-card-title>{{source.source_name}}</mat-card-title>
                  <mat-card-subtitle>Reliability Score: {{source.reliability_score | number:'1.2-2'}}</mat-card-subtitle>
                </mat-card-header>
                <mat-card-content>
                  <div class="reliability-stats">
                    <div class="stat">
                      <strong>{{source.avg_response_time | number:'1.1-1'}}</strong>
                      <span>Avg Response Days</span>
                    </div>
                    <div class="stat">
                      <strong>{{source.total_articles}}</strong>
                      <span>Articles</span>
                    </div>
                    <div class="stat" *ngIf="source.has_author_info">
                      <strong>{{source.has_author_info | number:'1.1-1'}}%</strong>
                      <span>Has Author</span>
                    </div>
                  </div>
                </mat-card-content>
              </mat-card>
            </div>
            <div *ngIf="newsReliability.length === 0" class="no-data">
              <p>No reliability data available. Fetch news articles to see analysis.</p>
            </div>
          </div>

          <!-- News Articles Section -->
          <div class="news-articles-section">
            <!-- Guardian Articles -->
            <div class="article-subsection">
              <div class="section-header">
                <h3>Historical News Coverage (Guardian)</h3>
                <button mat-raised-button color="primary" 
                        (click)="fetchHistoricalNews()" 
                        [disabled]="isLoadingNews">
                  <mat-icon *ngIf="isLoadingNews">refresh</mat-icon>
                  {{ isLoadingNews ? 'Fetching...' : 'Fetch Guardian Articles' }}
                </button>
              </div>
              
              <div *ngIf="newsData.guardian.length > 0" class="articles-table">
                <table mat-table [dataSource]="newsData.guardian" class="mat-elevation-z2">
                  <ng-container matColumnDef="headline">
                    <th mat-header-cell *matHeaderCellDef>Headline</th>
                    <td mat-cell *matCellDef="let article">{{article.headline}}</td>
                  </ng-container>
                  
                  <ng-container matColumnDef="source_name">
                    <th mat-header-cell *matHeaderCellDef>Source</th>
                    <td mat-cell *matCellDef="let article">{{article.source_name}}</td>
                  </ng-container>
                  
                  <ng-container matColumnDef="publication_date">
                    <th mat-header-cell *matHeaderCellDef>Date</th>
                    <td mat-cell *matCellDef="let article">{{article.publication_date | date:'short'}}</td>
                  </ng-container>
                  
                  <ng-container matColumnDef="url">
                    <th mat-header-cell *matHeaderCellDef>Link</th>
                    <td mat-cell *matCellDef="let article">
                      <a [href]="article.url" target="_blank" mat-button>
                        <mat-icon>open_in_new</mat-icon>
                        Read
                      </a>
                    </td>
                  </ng-container>
                  
                  <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                  <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                </table>
                <p class="article-count">Showing {{newsData.guardian.length}} Guardian articles</p>
              </div>
              
              <div *ngIf="newsData.guardian.length === 0 && !isLoadingNews" class="no-data">
                <p>No Guardian articles loaded. Click the button above to fetch historical news.</p>
              </div>
            </div>

            <!-- NewsAPI Articles -->
            <div class="article-subsection">
              <div class="section-header">
                <h3>Recent News Coverage (NewsAPI)</h3>
                <button mat-raised-button color="accent" 
                        (click)="fetchRecentNews()" 
                        [disabled]="isLoadingNews">
                  <mat-icon *ngIf="isLoadingNews">refresh</mat-icon>
                  {{ isLoadingNews ? 'Fetching...' : 'Fetch Recent News' }}
                </button>
              </div>
              
              <div *ngIf="newsData.newsapi.length > 0" class="articles-table">
                <table mat-table [dataSource]="newsData.newsapi" class="mat-elevation-z2">
                  <ng-container matColumnDef="headline">
                    <th mat-header-cell *matHeaderCellDef>Headline</th>
                    <td mat-cell *matCellDef="let article">{{article.headline}}</td>
                  </ng-container>
                  
                  <ng-container matColumnDef="source_name">
                    <th mat-header-cell *matHeaderCellDef>Source</th>
                    <td mat-cell *matCellDef="let article">{{article.source_name}}</td>
                  </ng-container>
                  
                  <ng-container matColumnDef="publication_date">
                    <th mat-header-cell *matHeaderCellDef>Date</th>
                    <td mat-cell *matCellDef="let article">{{article.publication_date | date:'short'}}</td>
                  </ng-container>
                  
                  <ng-container matColumnDef="url">
                    <th mat-header-cell *matHeaderCellDef>Link</th>
                    <td mat-cell *matCellDef="let article">
                      <a [href]="article.url" target="_blank" mat-button>
                        <mat-icon>open_in_new</mat-icon>
                        Read
                      </a>
                    </td>
                  </ng-container>
                  
                  <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                  <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                </table>
                <p class="article-count">Showing {{newsData.newsapi.length}} recent articles</p>
              </div>
              
              <div *ngIf="newsData.newsapi.length === 0 && !isLoadingNews" class="no-data">
                <p>No recent articles loaded. Click the button above to fetch recent news.</p>
              </div>
            </div>

            <!-- Loading State for News -->
            <div *ngIf="isLoadingNews" class="loading-container">
              <mat-spinner diameter="40"></mat-spinner>
              <p>Fetching news articles...</p>
            </div>
          </div>
        </div>
      </mat-tab>

      <mat-tab label="AI Insights">
        <div class="tab-content">
          <mat-card>
            <mat-card-header>
              <mat-card-title>Virality Prediction & Insights</mat-card-title>
              <mat-card-subtitle>ML-powered analysis</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <p>GNN virality scores, sentiment analysis, and topic modeling results will appear here.</p>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>
    </mat-tab-group>
  </div>

  <!-- Error State -->
  <div *ngIf="!isLoading && !topicData" class="error-container">
    <p>Topic not found.</p>
    <button mat-button (click)="goBackToLocker()">Back to Locker</button>
  </div>
</div>