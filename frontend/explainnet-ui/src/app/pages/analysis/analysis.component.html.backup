<div class="analysis-container" *ngIf="!loading && topic">
  <!-- Section A: Hero Header -->
  <header class="hero-header">
    <div class="header-top">
      <button class="btn-back" routerLink="/locker">
        <span class="back-icon">←</span>
        <span class="back-text">Back</span>
      </button>
      
      <button class="btn-delete-top" (click)="deleteTopic()">
        <span class="delete-icon">🗑</span>
      </button>
    </div>
    
    <h1 class="topic-title">{{ topic.topic_name }}</h1>
    
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon"></div>
        <div class="stat-value">{{ videos.length }}</div>
        <div class="stat-label">Videos Analyzed</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon"></div>
        <div class="stat-value">{{ articles.length }}</div>
        <div class="stat-label">News Articles</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon"></div>
        <div class="stat-value">{{ topic.overall_impact_score ? topic.overall_impact_score.toFixed(1) : '0' }}</div>
        <div class="stat-label">Avg Impact Score</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon"></div>
        <div class="stat-value">{{ topic.last_analyzed_at | date:'MMM d' }}</div>
        <div class="stat-label">Last Analyzed</div>
      </div>
    </div>
  </header>

  <!-- Tab Navigation -->
  <div class="tab-navigation">
    <button 
      class="tab-btn" 
      [class.active]="activeTab === 'videos'"
      (click)="switchTab('videos')">
      <span class="tab-icon">📹</span>
      Videos
    </button>
    <button 
      class="tab-btn" 
      [class.active]="activeTab === 'news'"
      (click)="switchTab('news')">
      <span class="tab-icon">📰</span>
      News
    </button>
    <button 
      class="tab-btn" 
      [class.active]="activeTab === 'ai'"
      (click)="switchTab('ai')">
      <span class="tab-icon">🤖</span>
      AI Analysis
    </button>
  </div>
  
  <!-- VIDEOS TAB CONTENT -->
  <div *ngIf="activeTab === 'videos'">
    <!-- Section B: Key Insights -->
    <section class="key-insights">
    <h2 class="section-title">Key Insights</h2>
    
    <div class="insights-grid">
      <div class="insight-card">
        <h3>Overall Sentiment</h3>
        <div class="sentiment-large" [ngClass]="getSentimentClass(topic.overall_sentiment)">
          {{ topic.overall_sentiment || 'Analyzing...' }}
          <span class="trend-indicator" [ngClass]="sentimentTrend">
            <span *ngIf="sentimentTrend === 'up'">↑</span>
            <span *ngIf="sentimentTrend === 'down'">↓</span>
            <span *ngIf="sentimentTrend === 'stable'">→</span>
          </span>
        </div>
        
        <div class="confidence-section" *ngIf="overallConfidence > 0">
          <div class="confidence-label">Confidence</div>
          <div class="confidence-circle">
            <svg viewBox="0 0 120 120" class="circular-progress">
              <circle cx="60" cy="60" r="54" class="progress-bg"></circle>
              <circle cx="60" cy="60" r="54" class="progress-fill" 
                      [style.stroke-dashoffset]="339 - (339 * overallConfidence / 100)"></circle>
            </svg>
            <div class="confidence-value">{{ overallConfidence }}%</div>
          </div>
        </div>

        <div class="dominant-emotion-badge" *ngIf="dominantEmotion">
          <span class="emotion-icon">{{ getEmotionIcon(dominantEmotion.name) }}</span>
          <span class="emotion-text">
            <strong>{{ dominantEmotion.name | titlecase }}</strong>
            <small>{{ dominantEmotion.percentage }}%</small>
          </span>
        </div>
      </div>
      
      <div class="insight-card gradient" *ngIf="topVideo">
        <h3>Top Impact Video</h3>
        <img [src]="topVideo.thumbnail_url" alt="Thumbnail" class="video-thumb">
        <p class="video-title">{{ topVideo.title }}</p>
        <div class="impact-badge">Impact: {{ topVideo.impact_score?.toFixed(1) }}</div>
      </div>
      
      <div class="insight-card dark-mode">
        <h3>Sentiment Distribution</h3>
        <div class="sentiment-bars">
          <div class="bar-item">
            <span class="bar-label">Positive</span>
            <div class="bar">
              <div class="bar-fill positive" [style.width.%]="(sentimentCounts.positive / videos.length) * 100"></div>
            </div>
            <span class="bar-percentage">{{ ((sentimentCounts.positive / videos.length) * 100) | number:'1.0-0' }}%</span>
            <span class="bar-count">{{ sentimentCounts.positive }}</span>
          </div>
          <div class="bar-item">
            <span class="bar-label">Negative</span>
            <div class="bar">
              <div class="bar-fill negative" [style.width.%]="(sentimentCounts.negative / videos.length) * 100"></div>
            </div>
            <span class="bar-percentage">{{ ((sentimentCounts.negative / videos.length) * 100) | number:'1.0-0' }}%</span>
            <span class="bar-count">{{ sentimentCounts.negative }}</span>
          </div>
          <div class="bar-item">
            <span class="bar-label">Neutral</span>
            <div class="bar">
              <div class="bar-fill neutral" [style.width.%]="(sentimentCounts.neutral / videos.length) * 100"></div>
            </div>
            <span class="bar-percentage">{{ ((sentimentCounts.neutral / videos.length) * 100) | number:'1.0-0' }}%</span>
            <span class="bar-count">{{ sentimentCounts.neutral }}</span>
          </div>
        </div>
        
        <div class="sentiment-velocity" *ngIf="videos.length > 1">
          <div class="velocity-label">Sentiment Velocity</div>
          <div class="velocity-meter">
            <div class="velocity-indicator" [ngClass]="sentimentTrend"></div>
          </div>
          <div class="velocity-text">{{ sentimentTrend | titlecase }}</div>
        </div>
      </div>
    </div>
  </section>
  
    <!-- Section D: Video Rankings Table -->
    <section class="video-table-section">
      <h2 class="section-title">Video Rankings</h2>
    
    <div class="table-container">
      <table class="video-table">
        <thead>
          <tr>
            <th>Video</th>
            <th (click)="setSortBy('impact_score')" class="sortable">
              Impact Score {{ sortBy === 'impact_score' ? (sortDirection === 'desc' ? '' : '') : '' }}
            </th>
            <th (click)="setSortBy('view_count')" class="sortable">
              Views {{ sortBy === 'view_count' ? (sortDirection === 'desc' ? '' : '') : '' }}
            </th>
            <th>Sentiment</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let video of filteredVideos" class="clickable">
            <td class="video-cell" (click)="$event.stopPropagation()">
              <a [href]="'https://www.youtube.com/watch?v=' + video.video_id" target="_blank">
                <img [src]="video.thumbnail_url" alt="Thumbnail" class="thumbnail">
              </a>
              <div class="video-info" (click)="openVideoModal(video)">
                <div class="video-title-text">{{ video.title }}</div>
                <div class="channel-name">{{ video.channel_title }}</div>
              </div>
            </td>
            <td>
              <div class="impact-score">{{ video.impact_score?.toFixed(2) || '—' }}</div>
            </td>
            <td>{{ formatNumber(video.view_count) }}</td>
            <td>
              <span class="sentiment-badge" [ngClass]="getSentimentClass(video.overall_sentiment)">
                {{ video.overall_sentiment || 'N/A' }}
              </span>
            </td>
            <td>
              <button class="btn-view" (click)="openVideoModal(video); $event.stopPropagation()">
                View Details
              </button>
            </td>
          </tr>
        </tbody>
      </table>
      
      <div class="empty-table" *ngIf="filteredVideos.length === 0">
        <p>No videos match your search</p>
      </div>
    </div>
  </section>

  <!-- Video Analytics Dashboard -->
  <section class="video-analytics-dashboard" *ngIf="videos.length > 0">
    <h2 class="section-title">📊 Video Analytics Dashboard</h2>
    
    <div class="analytics-grid">
      <!-- Chart 1: Impact Score Distribution (Pie) -->
      <div class="analytics-card">
        <h3 class="chart-title">Impact Score Distribution</h3>
        <div class="chart-container">
          <div class="impact-distribution">
            <div class="impact-segment low" 
                 [style.--percentage]="impactDistribution.low + '%'"
                 [attr.data-count]="impactDistribution.lowCount">
              <span class="segment-label">Low (0-2)</span>
              <span class="segment-value">{{ impactDistribution.lowCount }}</span>
            </div>
            <div class="impact-segment medium" 
                 [style.--percentage]="impactDistribution.medium + '%'"
                 [attr.data-count]="impactDistribution.mediumCount">
              <span class="segment-label">Medium (2-4)</span>
              <span class="segment-value">{{ impactDistribution.mediumCount }}</span>
            </div>
            <div class="impact-segment high" 
                 [style.--percentage]="impactDistribution.high + '%'"
                 [attr.data-count]="impactDistribution.highCount">
              <span class="segment-label">High (4-5)</span>
              <span class="segment-value">{{ impactDistribution.highCount }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Chart 2: Sentiment vs Views (Scatter) -->
      <div class="analytics-card">
        <h3 class="chart-title">Sentiment vs Views</h3>
        <div class="chart-container">
          <div class="scatter-plot">
            <div class="scatter-point" 
                 *ngFor="let video of videos.slice(0, 10)"
                 [style.left]="getScatterX(video.view_count) + '%'"
                 [style.bottom]="getScatterY(video.overall_sentiment) + '%'"
                 [ngClass]="getSentimentClass(video.overall_sentiment)"
                 [attr.data-impact]="video.impact_score"
                 [title]="video.title">
            </div>
            <div class="axis-label x-axis">Views</div>
            <div class="axis-label y-axis">Sentiment</div>
          </div>
        </div>
      </div>

      <!-- Chart 3: Top 5 Videos by Engagement -->
      <div class="analytics-card">
        <h3 class="chart-title">Top 5 by Engagement</h3>
        <div class="chart-container">
          <div class="engagement-bars">
            <div class="engagement-item" *ngFor="let video of topEngagementVideos">
              <div class="video-label">{{ video.title | slice:0:25 }}...</div>
              <div class="engagement-bar-container">
                <div class="engagement-bar" [style.width.%]="video.engagementPercentage">
                  <span class="engagement-value">{{ video.engagementRatio }}%</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Chart 4: Emotion Timeline -->
      <div class="analytics-card">
        <h3 class="chart-title">Emotion Timeline</h3>
        <div class="chart-container">
          <div class="emotion-timeline">
            <div class="timeline-line joy" [style.--points]="getEmotionPoints('joy')"></div>
            <div class="timeline-line sadness" [style.--points]="getEmotionPoints('sadness')"></div>
            <div class="timeline-line anger" [style.--points]="getEmotionPoints('anger')"></div>
            <div class="timeline-line fear" [style.--points]="getEmotionPoints('fear')"></div>
            <div class="timeline-line surprise" [style.--points]="getEmotionPoints('surprise')"></div>
            <div class="timeline-line disgust" [style.--points]="getEmotionPoints('disgust')"></div>
            <div class="emotion-legend">
              <span class="legend-item joy">Joy</span>
              <span class="legend-item sadness">Sadness</span>
              <span class="legend-item anger">Anger</span>
              <span class="legend-item fear">Fear</span>
              <span class="legend-item surprise">Surprise</span>
              <span class="legend-item disgust">Disgust</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Chart 5: View Count Distribution -->
      <div class="analytics-card">
        <h3 class="chart-title">View Count Distribution</h3>
        <div class="chart-container">
          <div class="histogram">
            <div class="histogram-bar" 
                 *ngFor="let bucket of viewDistribution"
                 [style.height.%]="bucket.percentage"
                 [title]="bucket.range + ': ' + bucket.count + ' videos'">
              <span class="bar-count">{{ bucket.count }}</span>
              <span class="bar-label">{{ bucket.label }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Chart 6: Impact Score Trend -->
      <div class="analytics-card">
        <h3 class="chart-title">Impact Score Trend</h3>
        <div class="chart-container">
          <div class="trend-chart">
            <svg viewBox="0 0 400 200" class="trend-svg">
              <defs>
                <linearGradient id="trendGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" style="stop-color:#C147E9;stop-opacity:0.5" />
                  <stop offset="100%" style="stop-color:#C147E9;stop-opacity:0.1" />
                </linearGradient>
              </defs>
              <polyline 
                [attr.points]="impactTrendPoints" 
                fill="url(#trendGradient)" 
                stroke="#C147E9" 
                stroke-width="3">
              </polyline>
              <polyline 
                [attr.points]="impactTrendLine" 
                fill="none" 
                stroke="#C147E9" 
                stroke-width="3">
              </polyline>
            </svg>
            <div class="trend-stats">
              <span class="trend-stat">Avg: {{ averageImpact | number:'1.1-1' }}</span>
              <span class="trend-stat">Max: {{ maxImpact | number:'1.1-1' }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  </div>

  <!-- NEWS TAB CONTENT -->
  <div *ngIf="activeTab === 'news'" class="news-tab">
    <section class="news-section">
      <h2 class="section-title">News Articles ({{ articles.length }})</h2>
      
      <div class="articles-grid">
        <div class="article-card" *ngFor="let article of articles">
          <div class="article-header">
            <span class="article-source">{{ article.source }}</span>
            <span class="relevance-badge" *ngIf="article.relevance_score !== null && article.relevance_score !== undefined">
              <span class="relevance-icon">✨</span>
              {{ article.relevance_score }}% Relevant
            </span>
          </div>
          
          <h3 class="article-title">
            <a [href]="article.url" target="_blank">{{ article.title }}</a>
          </h3>
          
          <p class="article-description">{{ article.description }}</p>
          
          <div class="article-footer">
            <span class="article-author" *ngIf="article.author">{{ article.author }}</span>
            <span class="article-date">{{ formatDate(article.published_at) }}</span>
          </div>
              <div class="article-justifications">
                <p *ngIf="article.hf_justification">
                  <strong>VADER:</strong>
                  <span *ngIf="!isArticleExpanded(article.id)">
                    {{ article.hf_justification | slice:0:200 }}
                    <span *ngIf="article.hf_justification.length > 200">... <a href="#" (click)="toggleArticleExpand(article.id, $event)">Show more</a></span>
                  </span>
                  <span *ngIf="isArticleExpanded(article.id)">
                    {{ article.hf_justification }} <a href="#" (click)="toggleArticleExpand(article.id, $event)">Show less</a>
                  </span>
                </p>

                <p *ngIf="article.gemini_justification">
                  <strong>Gemini:</strong>
                  <span *ngIf="!isArticleExpanded(article.id)">
                    {{ article.gemini_justification | slice:0:200 }}
                    <span *ngIf="article.gemini_justification.length > 200">... <a href="#" (click)="toggleArticleExpand(article.id, $event)">Show more</a></span>
                  </span>
                  <span *ngIf="isArticleExpanded(article.id)">
                    {{ article.gemini_justification }} <a href="#" (click)="toggleArticleExpand(article.id, $event)">Show less</a>
                  </span>
                </p>
              </div>
        </div>
      </div>
      
      <div class="empty-state" *ngIf="articles.length === 0">
        <p>No news articles found</p>
      </div>

      <!-- News Timeline Dashboard -->
      <section class="news-timeline-dashboard" *ngIf="articles.length > 0">
        <h2 class="section-title">📰 News Timeline</h2>
        
        <div class="timeline-controls">
          <div class="control-group">
            <label>Sort Order:</label>
            <div class="btn-group">
              <button 
                [class.active]="timelineSortOrder === 'asc'" 
                (click)="timelineSortOrder = 'asc'"
                class="btn-sort">
                ⬆ Oldest First
              </button>
              <button 
                [class.active]="timelineSortOrder === 'desc'" 
                (click)="timelineSortOrder = 'desc'"
                class="btn-sort">
                ⬇ Newest First
              </button>
            </div>
          </div>
        </div>

        <div class="timeline-chart">
          <div class="timeline-bar" *ngFor="let article of sortedArticles; let i = index">
            <div class="timeline-marker" [style.left]="getTimelinePosition(article.published_at) + '%'">
              <div class="marker-dot" [style.background]="getRelevanceColor(article.relevance_score)"></div>
              <div class="marker-tooltip">
                <div class="tooltip-title">{{ article.title | slice:0:50 }}...</div>
                <div class="tooltip-meta">
                  <span>{{ formatDate(article.published_at) }}</span>
                  <span *ngIf="article.relevance_score">{{ article.relevance_score }}% relevant</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="timeline-axis">
            <span class="axis-label start">{{ timelineStartDate }}</span>
            <span class="axis-label end">{{ timelineEndDate }}</span>
          </div>
        </div>

        <div class="timeline-summary">
          <div class="summary-stat">
            <span class="stat-value">{{ articles.length }}</span>
            <span class="stat-label">Total Articles</span>
          </div>
          <div class="summary-stat">
            <span class="stat-value">{{ averageRelevance | number:'1.0-0' }}%</span>
            <span class="stat-label">Avg Relevance</span>
          </div>
          <div class="summary-stat">
            <span class="stat-value">{{ articleDateRange }}</span>
            <span class="stat-label">Date Range</span>
          </div>
        </div>
      </section>
    </section>
  </div>

  <!-- AI ANALYSIS TAB CONTENT -->
  <div *ngIf="activeTab === 'ai'" class="ai-tab">
    <section class="ai-synthesis-dashboard" *ngIf="aiSummary">
      
      <!-- Hero Card with Executive Summary -->
      <div class="hero-card">
        <div class="hero-header">
          <h2 class="hero-title">🤖 AI-Powered Comprehensive Analysis</h2>
          <div class="models-used">
            <span class="model-badge vader">📊 VADER</span>
            <span class="model-badge gemini">✨ Gemini AI</span>
          </div>
        </div>
        <div class="executive-summary">
          <h3>Executive Summary</h3>
          <p>{{ aiSummary.executive_summary }}</p>
        </div>
      </div>

      <!-- Key Metrics Row -->
      <div class="metrics-row">
        <div class="metric-card">
          <div class="metric-icon">🎥</div>
          <div class="metric-value">{{ videos.length }}</div>
          <div class="metric-label">Videos Analyzed</div>
        </div>
        <div class="metric-card">
          <div class="metric-icon">{{ getSentimentIcon(topic.overall_sentiment) }}</div>
          <div class="metric-value">{{ topic.overall_sentiment | titlecase }}</div>
          <div class="metric-label">Dominant Sentiment</div>
        </div>
        <div class="metric-card">
          <div class="metric-icon">⚡</div>
          <div class="metric-value">{{ averageImpact | number:'1.1-1' }}</div>
          <div class="metric-label">Avg Impact Score</div>
        </div>
        <div class="metric-card" *ngIf="aiSummary.dominant_emotion">
          <div class="metric-icon">{{ getEmotionIcon(aiSummary.dominant_emotion) }}</div>
          <div class="metric-value">{{ aiSummary.dominant_emotion | titlecase }}</div>
          <div class="metric-label">Top Emotion</div>
        </div>
      </div>

      <!-- Combined Analytics Section -->
      <div class="combined-analytics">
        <h3 class="section-heading">📈 Combined Analytics</h3>
        
        <div class="analytics-grid-ai">
          <!-- Chart 1: Content Quality Assessment -->
          <div class="analytics-card-ai glass">
            <h4>Content Quality</h4>
            <div class="quality-meter">
              <div class="quality-bar" [style.width]="getQualityPercentage() + '%'">
                <span class="quality-label">{{ aiSummary.content_quality_assessment }}</span>
              </div>
            </div>
            <div class="quality-details">
              <div class="detail-item">
                <span class="detail-label">Videos:</span>
                <span class="detail-value">{{ videos.length }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">News:</span>
                <span class="detail-value">{{ articles.length }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Avg Relevance:</span>
                <span class="detail-value">{{ averageRelevance | number:'1.0-0' }}%</span>
              </div>
            </div>
          </div>

          <!-- Chart 2: Sentiment Comparison -->
          <div class="analytics-card-ai glass">
            <h4>Sentiment Distribution</h4>
            <div class="sentiment-pie">
              <div class="pie-segment positive" [style.--percentage]="sentimentCounts.positive / videos.length * 100 + '%'">
                <span class="segment-count">{{ sentimentCounts.positive }}</span>
              </div>
              <div class="pie-segment negative" [style.--percentage]="sentimentCounts.negative / videos.length * 100 + '%'">
                <span class="segment-count">{{ sentimentCounts.negative }}</span>
              </div>
              <div class="pie-segment neutral" [style.--percentage]="sentimentCounts.neutral / videos.length * 100 + '%'">
                <span class="segment-count">{{ sentimentCounts.neutral }}</span>
              </div>
            </div>
            <div class="sentiment-legend-ai">
              <div class="legend-item-ai positive">Positive: {{ sentimentCounts.positive }}</div>
              <div class="legend-item-ai negative">Negative: {{ sentimentCounts.negative }}</div>
              <div class="legend-item-ai neutral">Neutral: {{ sentimentCounts.neutral }}</div>
            </div>
          </div>

          <!-- Chart 3: Impact vs Relevance -->
          <div class="analytics-card-ai glass">
            <h4>Impact vs Relevance</h4>
            <div class="correlation-chart">
              <div class="correlation-bar">
                <div class="bar-section impact" [style.width]="(averageImpact / 5 * 100) + '%'">
                  <span>Impact: {{ averageImpact | number:'1.1-1' }}</span>
                </div>
              </div>
              <div class="correlation-bar">
                <div class="bar-section relevance" [style.width]="averageRelevance + '%'">
                  <span>Relevance: {{ averageRelevance | number:'1.0-0' }}%</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Chart 4: Emotion Heatmap -->
          <div class="analytics-card-ai glass">
            <h4>Emotion Heatmap</h4>
            <div class="emotion-heatmap">
              <div class="heatmap-cell joy" [style.opacity]="getRandomOpacity()">
                <span class="cell-label">Joy</span>
              </div>
              <div class="heatmap-cell sadness" [style.opacity]="getRandomOpacity()">
                <span class="cell-label">Sadness</span>
              </div>
              <div class="heatmap-cell anger" [style.opacity]="getRandomOpacity()">
                <span class="cell-label">Anger</span>
              </div>
              <div class="heatmap-cell fear" [style.opacity]="getRandomOpacity()">
                <span class="cell-label">Fear</span>
              </div>
              <div class="heatmap-cell surprise" [style.opacity]="getRandomOpacity()">
                <span class="cell-label">Surprise</span>
              </div>
              <div class="heatmap-cell disgust" [style.opacity]="getRandomOpacity()">
                <span class="cell-label">Disgust</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- AI Insights Panel -->
      <div class="insights-panel">
        <div class="insight-column">
          <h3 class="insight-heading">🔍 Key Trends</h3>
          <ul class="insight-list">
            <li *ngFor="let trend of aiSummary.key_trends">{{ trend }}</li>
          </ul>
        </div>

        <div class="insight-column">
          <h3 class="insight-heading">💡 Surprising Findings</h3>
          <ul class="insight-list">
            <li *ngFor="let finding of aiSummary.surprising_findings">{{ finding }}</li>
          </ul>
        </div>

        <div class="insight-column">
          <h3 class="insight-heading">🎯 Recommendations</h3>
          <ul class="insight-list">
            <li *ngFor="let rec of aiSummary.recommendations">{{ rec }}</li>
          </ul>
        </div>
      </div>

    </section>
    
    <div class="loading-container" *ngIf="!aiSummary">
      <div class="loading-spinner"></div>
      <p class="loading-title">Generating AI Synthesis</p>
      <p class="loading-subtitle">Analyzing videos, sentiments, emotions, and news relevance...</p>
    </div>
  </div>
  <!-- End of AI Tab -->

  <!-- Modal and Loading sections (outside tabs, but inside main container) -->
</div>
<!-- End of Main Analysis Container -->

<div class="loading-container" *ngIf="loading">
  <div class="spinner"></div>
  <p>Loading analysis...</p>
</div>

<!-- Video Deep-Dive Modal -->
<div class="modal-overlay" *ngIf="showVideoModal && selectedVideo" (click)="closeVideoModal()">
  <div class="modal-content large" (click)="$event.stopPropagation()">
    <button class="modal-close" (click)="closeVideoModal()"></button>
    
    <div class="modal-header">
      <a [href]="'https://www.youtube.com/watch?v=' + selectedVideo.video_id" target="_blank" class="video-link">
        <img [src]="selectedVideo.thumbnail_url" alt="Thumbnail" class="modal-thumbnail">
      </a>
      <div class="modal-title-section">
        <h2>
          <a [href]="'https://www.youtube.com/watch?v=' + selectedVideo.video_id" target="_blank" class="video-title-link">
            {{ selectedVideo.title }}
          </a>
        </h2>
        <p class="modal-channel">{{ selectedVideo.channel_title }}</p>
      </div>
    </div>
    
    <div class="modal-tabs">
      <div class="tab-content">
        <h3>Transcript</h3>
        <div class="transcript-container" *ngIf="videoTranscript">
          <div class="transcript-box">
            <p class="transcript-text">{{ videoTranscript.text }}</p>
            <div class="transcript-stats">
              <span class="stat-badge">📝 {{ videoTranscript.word_count }} words</span>
              <span class="stat-badge" *ngIf="videoTranscript.processing_time">⏱️ {{ videoTranscript.processing_time.toFixed(1) }}s</span>
              <span class="stat-badge">🔤 {{ videoTranscript.language?.toUpperCase() }}</span>
            </div>
          </div>
        </div>
        <p *ngIf="!videoTranscript" class="loading-text">Loading transcript...</p>
        
        <h3>🎯 Sentiment Analysis</h3>
        <div class="sentiment-comparison" *ngIf="videoSentiments.length > 0">
          <div class="sentiment-model" *ngFor="let sentiment of videoSentiments">
            <h4>{{ sentiment.model_name === 'vader' ? '📊 VADER ANALYSIS' : sentiment.model_name === 'huggingface' ? '📊 VADER ANALYSIS' : '✨ GEMINI ANALYSIS' }}</h4>
            
            <div class="sentiment-result" [ngClass]="(sentiment.sentiment || '').toLowerCase()">
              {{ sentiment.sentiment }}
            </div>
            
            <div class="confidence-bar" *ngIf="sentiment.confidence">
              <div class="confidence-label">
                <span>Confidence</span>
                <span>{{ (sentiment.confidence * 100).toFixed(1) }}%</span>
              </div>
              <div class="bar-container">
                <div class="bar-fill" [style.width.%]="sentiment.confidence * 100"></div>
              </div>
            </div>
            
            <div class="sentiment-scores" *ngIf="sentiment.positive_score !== undefined && sentiment.negative_score !== undefined">
              <div class="score-item">
                <div class="score-label">Positive</div>
                <div class="score-value">{{ (sentiment.positive_score * 100).toFixed(1) }}%</div>
              </div>
              <div class="score-item">
                <div class="score-label">Negative</div>
                <div class="score-value">{{ (sentiment.negative_score * 100).toFixed(1) }}%</div>
              </div>
            </div>
            
            <!-- Model Justification -->
            <div class="model-justification" *ngIf="sentiment.hf_justification || sentiment.gemini_justification || sentiment.gemini_sarcasm_score !== undefined">
              <h5>Explanation</h5>
              <p class="justification-text" *ngIf="sentiment.hf_justification && (sentiment.model_name || '').toLowerCase().includes('hugging')">
                <strong>HF:</strong>
                <span *ngIf="!isSentimentExpanded(sentiment.id)">
                  {{ sentiment.hf_justification | slice:0:220 }}
                  <span *ngIf="sentiment.hf_justification.length > 220">... <a href="#" (click)="toggleSentimentExpand(sentiment.id, $event)">Show more</a></span>
                </span>
                <span *ngIf="isSentimentExpanded(sentiment.id)">
                  {{ sentiment.hf_justification }} <a href="#" (click)="toggleSentimentExpand(sentiment.id, $event)">Show less</a>
                </span>
              </p>
              <p class="justification-text" *ngIf="sentiment.gemini_justification && (sentiment.model_name || '').toLowerCase().includes('gemini')">
                <strong>Gemini:</strong>
                <span *ngIf="!isSentimentExpanded(sentiment.id)">
                  {{ sentiment.gemini_justification | slice:0:220 }}
                  <span *ngIf="sentiment.gemini_justification.length > 220">... <a href="#" (click)="toggleSentimentExpand(sentiment.id, $event)">Show more</a></span>
                </span>
                <span *ngIf="isSentimentExpanded(sentiment.id)">
                  {{ sentiment.gemini_justification }} <a href="#" (click)="toggleSentimentExpand(sentiment.id, $event)">Show less</a>
                </span>
              </p>

              <!-- Emotions Section (only for Gemini) -->
              <div class="emotions-section" *ngIf="sentiment.emotions_json && (sentiment.model_name || '').toLowerCase().includes('gemini')">
                <h5>Emotions Detected</h5>
                <div class="emotion-bars">
                  <div class="emotion-bar" *ngFor="let emotion of parseEmotions(sentiment.emotions_json)">
                    <div class="emotion-label">{{ emotion.name | titlecase }}</div>
                    <div class="emotion-meter">
                      <div class="emotion-fill" 
                           [style.width.%]="emotion.value" 
                           [ngClass]="'emotion-' + emotion.name"></div>
                    </div>
                    <div class="emotion-value">{{ emotion.value }}%</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Comments Section -->
        <div class="comments-section" *ngIf="videoComments.length > 0">
          <div class="section-header">
            <h3>💬 User Comments Analysis</h3>
            <span class="comments-count">{{ videoComments.length }} Comments</span>
          </div>
          
          <div class="comments-list">
            <div class="comment-item" *ngFor="let comment of videoComments">
              <div class="comment-header">
                <div class="comment-author">{{ comment.author }}</div>
                <div class="comment-meta">
                  <span class="like-count" *ngIf="comment.like_count > 0">{{ comment.like_count }}</span>
                  <span class="comment-date" *ngIf="comment.published_at">{{ formatDate(comment.published_at) }}</span>
                </div>
              </div>
              
              <div class="comment-text">{{ comment.text }}</div>
              
              <div class="comment-sentiments">
                <div class="sentiment-badge vader" [ngClass]="comment.hf_sentiment?.toLowerCase()">
                  <span class="model-label">📊 VADER</span>
                  <span class="sentiment-value">{{ comment.hf_sentiment || 'N/A' }}</span>
                </div>
                <div class="sentiment-badge gemini" [ngClass]="comment.gemini_sentiment?.toLowerCase()">
                  <span class="model-label">✨ Gemini</span>
                  <span class="sentiment-value">{{ comment.gemini_sentiment || 'N/A' }}</span>
                </div>
              </div>
              
              <div class="comment-justifications">
                <p class="justification" *ngIf="comment.hf_justification">
                  <strong>VADER:</strong>
                  <span *ngIf="!isCommentExpanded(comment.id)">
                    {{ comment.hf_justification | slice:0:180 }}
                    <span *ngIf="comment.hf_justification.length > 180">... <a href="#" (click)="toggleCommentExpand(comment.id, $event)">Show more</a></span>
                  </span>
                  <span *ngIf="isCommentExpanded(comment.id)">
                    {{ comment.hf_justification }} <a href="#" (click)="toggleCommentExpand(comment.id, $event)">Show less</a>
                  </span>
                </p>

                <p class="justification" *ngIf="comment.gemini_justification">
                  <strong>Gemini:</strong>
                  <span *ngIf="!isCommentExpanded(comment.id)">
                    {{ comment.gemini_justification | slice:0:180 }}
                    <span *ngIf="comment.gemini_justification.length > 180">... <a href="#" (click)="toggleCommentExpand(comment.id, $event)">Show more</a></span>
                  </span>
                  <span *ngIf="isCommentExpanded(comment.id)">
                    {{ comment.gemini_justification }} <a href="#" (click)="toggleCommentExpand(comment.id, $event)">Show less</a>
                  </span>
                </p>

                <div class="comment-emotions" *ngIf="comment.gemini_emotions_json">
                  <strong>Emotions:</strong>
                  <div class="emotion-mini-bars">
                    <ng-container *ngFor="let emotion of parseEmotions(comment.gemini_emotions_json)">
                      <span class="emotion-mini" *ngIf="emotion.value > 10">
                        <span class="emotion-mini-name">{{ emotion.name }}</span>
                        <span class="emotion-mini-value">{{ emotion.value }}%</span>
                      </span>
                    </ng-container>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading State -->
<div class="loading-container" *ngIf="loading">
  <div class="loading-spinner"></div>
  <h2 class="loading-title">Loading Analysis...</h2>
  <p class="loading-subtitle">Gathering insights for {{ topic?.topic_name || 'your topic' }}</p>
</div>
