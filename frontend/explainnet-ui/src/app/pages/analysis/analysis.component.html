<!-- Loading State -->
<div class="loading-container" *ngIf="loading">
  <div class="spinner"></div>
  <h2>Loading Analysis...</h2>
  <p>Gathering insights...</p>
</div>

<div class="analysis-container" *ngIf="!loading && topic">
  <!-- Hero Header -->
  <header class="hero-header">
    <div class="header-actions">
      <button class="btn-back" routerLink="/locker">
        <span class="back-icon">â†</span>
        <span>Back to Dashboard</span>
      </button>
      
      <div class="actions-right">
        <button class="theme-toggle" (click)="toggleTheme()">
          <span class="theme-icon">{{ themeService.isDark() ? 'â˜€ï¸' : 'ğŸŒ™' }}</span>
        </button>
        
        <button class="btn-export" (click)="exportData()">
          <span class="export-icon">ğŸ“Š</span>
          <span>Export</span>
        </button>
        
        <button class="btn-delete" (click)="deleteTopic()">
          <span class="delete-icon">ğŸ—‘ï¸</span>
        </button>
      </div>
    </div>
    
    <div class="hero-content">
      <div class="topic-badge">
        <span class="badge-icon">ğŸ¯</span>
        <span>Topic Analysis</span>
      </div>
      
      <h1 class="topic-title">{{ topic.topic_name }}</h1>
      
      <div class="hero-stats">
        <div class="hero-stat-item">
          <span class="stat-icon">ğŸ¥</span>
          <div class="stat-details">
            <span class="stat-value">{{ videos.length }}</span>
            <span class="stat-label">Videos</span>
          </div>
        </div>
        
        <div class="hero-stat-item">
          <span class="stat-icon">ğŸ“°</span>
          <div class="stat-details">
            <span class="stat-value">{{ articles.length }}</span>
            <span class="stat-label">Articles</span>
          </div>
        </div>
        
        <div class="hero-stat-item">
          <span class="stat-icon">{{ getSentimentIcon(topic.overall_sentiment) }}</span>
          <div class="stat-details">
            <span class="stat-value">{{ topic.overall_sentiment || 'N/A' }}</span>
            <span class="stat-label">Sentiment</span>
          </div>
        </div>
        
        <div class="hero-stat-item">
          <span class="stat-icon">âš¡</span>
          <div class="stat-details">
            <span class="stat-value">{{ averageImpact | number:'1.1-1' }}</span>
            <span class="stat-label">Avg Impact</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="gradient-orbs">
      <div class="orb orb-1"></div>
      <div class="orb orb-2"></div>
      <div class="orb orb-3"></div>
    </div>
  </header>

  <!-- Tab Navigation -->
  <nav class="tab-navigation">
    <button class="tab-btn" [class.active]="activeTab === 'overview'" (click)="switchTab('overview')">
      <span class="tab-icon">ğŸ“Š</span>
      <span>Overview</span>
    </button>
    <button class="tab-btn" [class.active]="activeTab === 'videos'" (click)="switchTab('videos')">
      <span class="tab-icon">ğŸ¥</span>
      <span>Videos ({{ videos.length }})</span>
    </button>
    <button class="tab-btn" [class.active]="activeTab === 'news'" (click)="switchTab('news')">
      <span class="tab-icon">ğŸ“°</span>
      <span>News ({{ articles.length }})</span>
    </button>
    <button class="tab-btn" [class.active]="activeTab === 'ai'" (click)="switchTab('ai')">
      <span class="tab-icon">ğŸ¤–</span>
      <span>AI Insights</span>
    </button>
  </nav>

  <!-- OVERVIEW TAB -->
  <div class="tab-content" *ngIf="activeTab === 'overview'">
    <!-- Quick Stats Grid -->
    <section class="quick-stats">
      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-icon">ğŸ˜Š</span>
          <span class="stat-badge positive">{{ sentimentCounts.positive }}</span>
        </div>
        <div class="stat-body">
          <span class="stat-label">Positive</span>
          <span class="stat-percentage">{{ getPercentage(sentimentCounts.positive) }}%</span>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-icon">ğŸ˜</span>
          <span class="stat-badge neutral">{{ sentimentCounts.neutral }}</span>
        </div>
        <div class="stat-body">
          <span class="stat-label">Neutral</span>
          <span class="stat-percentage">{{ getPercentage(sentimentCounts.neutral) }}%</span>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-icon">ğŸ˜Ÿ</span>
          <span class="stat-badge negative">{{ sentimentCounts.negative }}</span>
        </div>
        <div class="stat-body">
          <span class="stat-label">Negative</span>
          <span class="stat-percentage">{{ getPercentage(sentimentCounts.negative) }}%</span>
        </div>
      </div>
      
      <div class="stat-card highlight">
        <div class="stat-header">
          <span class="stat-icon">ğŸ”¥</span>
          <span class="stat-badge">{{ overallConfidence }}%</span>
        </div>
        <div class="stat-body">
          <span class="stat-label">Confidence</span>
          <span class="stat-percentage">High</span>
        </div>
      </div>
    </section>

    <!-- Key Insights Bento Grid -->
    <section class="insights-grid">
      <!-- Top Video Card -->
      <div class="insight-card featured" *ngIf="topVideo">
        <h3>ğŸ† Top Impact Video</h3>
        <img [src]="topVideo.thumbnail_url" alt="Top video thumbnail" class="video-thumbnail">
        <p class="video-title-text">{{ topVideo.title }}</p>
        <div class="video-meta">
          <span class="meta-item">
            <span class="meta-icon">ğŸ‘ï¸</span>
            {{ formatNumber(topVideo.view_count) }}
          </span>
          <span class="meta-item">
            <span class="meta-icon">âš¡</span>
            {{ topVideo.impact_score?.toFixed(2) }}
          </span>
        </div>
      </div>

      <!-- Sentiment Trend Card -->
      <div class="insight-card">
        <h3>ğŸ“ˆ Sentiment Trend</h3>
        <div class="trend-indicator" [ngClass]="sentimentTrend">
          <span class="trend-arrow" *ngIf="sentimentTrend === 'up'">â†‘</span>
          <span class="trend-arrow" *ngIf="sentimentTrend === 'down'">â†“</span>
          <span class="trend-arrow" *ngIf="sentimentTrend === 'stable'">â†’</span>
          <span class="trend-label">{{ sentimentTrend | titlecase }}</span>
        </div>
        <div class="mini-chart">
          <svg viewBox="0 0 200 80" class="sparkline-svg">
            <polyline [attr.points]="getSparklinePoints()" fill="none" stroke="var(--accent-cyan)" stroke-width="2"></polyline>
          </svg>
        </div>
      </div>

      <!-- Dominant Emotion Card -->
      <div class="insight-card" *ngIf="dominantEmotion">
        <h3>ğŸ­ Dominant Emotion</h3>
        <div class="emotion-display">
          <span class="emotion-icon-large">{{ getEmotionIcon(dominantEmotion.name) }}</span>
          <span class="emotion-name">{{ dominantEmotion.name | titlecase }}</span>
          <span class="emotion-percentage">{{ dominantEmotion.percentage }}%</span>
        </div>
      </div>

      <!-- Engagement Metrics -->
      <div class="insight-card">
        <h3>ğŸ’¬ Engagement</h3>
        <div class="engagement-stats">
          <div class="engagement-row">
            <span class="engagement-label">Avg Views</span>
            <span class="engagement-value">{{ getAvgViews() }}</span>
          </div>
          <div class="engagement-row">
            <span class="engagement-label">Total Likes</span>
            <span class="engagement-value">{{ getTotalLikes() }}</span>
          </div>
          <div class="engagement-row">
            <span class="engagement-label">Comments</span>
            <span class="engagement-value">{{ getTotalComments() }}</span>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- VIDEOS TAB -->
  <div class="tab-content" *ngIf="activeTab === 'videos'">
    <!-- Search & Filter Bar -->
    <div class="content-toolbar">
      <div class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input type="text" placeholder="Search videos..." [(ngModel)]="searchTerm" class="search-input">
      </div>
      
      <div class="toolbar-actions">
        <button class="action-btn" (click)="setSortBy('impact_score')">
          <span>Impact</span>
          <span *ngIf="sortBy === 'impact_score'">{{ sortDirection === 'desc' ? 'â†“' : 'â†‘' }}</span>
        </button>
        <button class="action-btn" (click)="setSortBy('view_count')">
          <span>Views</span>
          <span *ngIf="sortBy === 'view_count'">{{ sortDirection === 'desc' ? 'â†“' : 'â†‘' }}</span>
        </button>
      </div>
    </div>

    <!-- Videos Grid -->
    <div class="videos-grid">
      <div class="video-card" *ngFor="let video of filteredVideos" (click)="openVideoModal(video)">
        <img [src]="video.thumbnail_url" alt="Video thumbnail" class="video-thumbnail">
        
        <div class="video-info">
          <h4 class="video-title">{{ video.title }}</h4>
          <p class="video-channel">{{ video.channel_title }}</p>
          
          <div class="video-stats">
            <span class="stat-badge">
              <span>ğŸ‘ï¸</span>
              {{ formatNumber(video.view_count) }}
            </span>
            <span class="stat-badge">
              <span>âš¡</span>
              {{ video.impact_score?.toFixed(1) }}
            </span>
            <span class="sentiment-badge" [ngClass]="getSentimentClass(video.overall_sentiment)">
              {{ video.overall_sentiment }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <div class="empty-state" *ngIf="filteredVideos.length === 0">
      <span class="empty-icon">ğŸ¥</span>
      <p>No videos found</p>
    </div>
  </div>

  <!-- NEWS TAB -->
  <div class="tab-content" *ngIf="activeTab === 'news'">
    <div class="articles-grid">
      <article class="article-card" *ngFor="let article of articles">
        <div class="article-header">
          <span class="article-source">{{ article.source }}</span>
          <span class="relevance-badge" *ngIf="article.relevance_score">
            âœ¨ {{ article.relevance_score }}%
          </span>
        </div>
        
        <h3 class="article-title">
          <a [href]="article.url" target="_blank">{{ article.title }}</a>
        </h3>
        
        <p class="article-description">{{ article.description }}</p>
        
        <div class="article-footer">
          <span class="article-author" *ngIf="article.author">{{ article.author }}</span>
          <span class="article-date">{{ formatDate(article.published_at) }}</span>
        </div>
      </article>
    </div>

    <div class="empty-state" *ngIf="articles.length === 0">
      <span class="empty-icon">ğŸ“°</span>
      <p>No news articles found</p>
    </div>
  </div>

  <!-- AI INSIGHTS TAB -->
  <div class="tab-content" *ngIf="activeTab === 'ai'">
    <div class="ai-insights" *ngIf="aiSummary; else aiLoading">
      <!-- Executive Summary Card -->
      <div class="summary-card">
        <div class="summary-header">
          <div class="summary-title-group">
            <h2>ğŸ¤– AI Executive Summary</h2>
            <div class="model-badges">
              <span class="model-badge vader">VADER</span>
              <span class="model-badge gemini">Gemini AI</span>
            </div>
          </div>
          <div class="summary-actions">
            <button class="btn-regenerate" (click)="regenerateAIInsights()" [disabled]="regeneratingAI">
              <span class="regenerate-icon">{{ regeneratingAI ? 'â³' : 'ğŸ”„' }}</span>
              <span>{{ regeneratingAI ? 'Regenerating...' : 'Regenerate' }}</span>
            </button>
            <span class="cache-info" *ngIf="aiSummary.from_cache">
              <span class="cache-icon">ğŸ’¾</span>
              <span class="cache-text">Cached {{ aiSummary.cache_age_hours }}h ago</span>
            </span>
            <span class="cache-info fresh" *ngIf="!aiSummary.from_cache">
              <span class="cache-icon">âœ¨</span>
              <span class="cache-text">Fresh analysis</span>
            </span>
          </div>
        </div>
        <p class="summary-text">{{ aiSummary.executive_summary }}</p>
      </div>

      <!-- Insights Grid -->
      <div class="insights-columns">
        <div class="insight-column">
          <h3>ğŸ” Key Trends</h3>
          <ul class="insight-list">
            <li *ngFor="let trend of aiSummary.key_trends">{{ trend }}</li>
          </ul>
        </div>

        <div class="insight-column">
          <h3>ğŸ’¡ Surprising Findings</h3>
          <ul class="insight-list">
            <li *ngFor="let finding of aiSummary.surprising_findings">{{ finding }}</li>
          </ul>
        </div>

        <div class="insight-column">
          <h3>ğŸ¯ Recommendations</h3>
          <ul class="insight-list">
            <li *ngFor="let rec of aiSummary.recommendations">{{ rec }}</li>
          </ul>
        </div>
      </div>
    </div>

    <ng-template #aiLoading>
      <div class="loading-state">
        <div class="spinner"></div>
        <h3>Generating AI Insights...</h3>
        <p>Analyzing sentiment patterns and trends</p>
      </div>
    </ng-template>
  </div>
</div>

<!-- Video Modal -->
<div class="modal-overlay" *ngIf="showVideoModal && selectedVideo" (click)="closeVideoModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <button class="modal-close" (click)="closeVideoModal()">Ã—</button>
    
    <div class="modal-header">
      <img [src]="selectedVideo.thumbnail_url" alt="Video thumbnail" class="modal-thumbnail">
      <h2>{{ selectedVideo.title }}</h2>
      <p class="modal-channel">{{ selectedVideo.channel_title }}</p>
    </div>
    
    <div class="modal-tabs">
      <button class="modal-tab-btn" [class.active]="modalTab === 'transcript'" (click)="modalTab = 'transcript'">
        Transcript
      </button>
      <button class="modal-tab-btn" [class.active]="modalTab === 'sentiment'" (click)="modalTab = 'sentiment'">
        Sentiment
      </button>
      <button class="modal-tab-btn" [class.active]="modalTab === 'comments'" (click)="modalTab = 'comments'">
        Comments
      </button>
    </div>
    
    <div class="modal-body">
      <!-- Transcript Tab -->
      <div *ngIf="modalTab === 'transcript'">
        <div class="transcript-box" *ngIf="videoTranscript">
          <p>{{ videoTranscript.text }}</p>
          <div class="transcript-stats">
            <span>ğŸ“ {{ videoTranscript.word_count }} words</span>
            <span>ğŸ”¤ {{ videoTranscript.language?.toUpperCase() }}</span>
          </div>
        </div>
        <p *ngIf="!videoTranscript" class="loading-text">Loading transcript...</p>
      </div>

      <!-- Sentiment Tab -->
      <div *ngIf="modalTab === 'sentiment'">
        <div class="sentiment-grid">
          <div class="sentiment-card" *ngFor="let sentiment of videoSentiments">
            <h4>{{ sentiment.model_name === 'vader' ? 'ğŸ“Š VADER' : 'âœ¨ Gemini' }}</h4>
            <div class="sentiment-result" [ngClass]="getSentimentClass(sentiment.sentiment)">
              {{ sentiment.sentiment }}
            </div>
            <div class="confidence-bar" *ngIf="sentiment.confidence">
              <span class="confidence-label">{{ (sentiment.confidence * 100).toFixed(1) }}% Confidence</span>
              <div class="bar">
                <div class="bar-fill" [style.width.%]="sentiment.confidence * 100"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Comments Tab -->
      <div *ngIf="modalTab === 'comments'">
        <div class="comments-list">
          <div class="comment-item" *ngFor="let comment of videoComments">
            <div class="comment-header">
              <span class="comment-author">{{ comment.author }}</span>
              <span class="comment-likes" *ngIf="comment.like_count">ğŸ‘ {{ comment.like_count }}</span>
            </div>
            <p class="comment-text">{{ comment.text }}</p>
            <div class="comment-sentiments">
              <span class="sentiment-tag vader" [ngClass]="getSentimentClass(comment.hf_sentiment)">
                VADER: {{ comment.hf_sentiment }}
              </span>
              <span class="sentiment-tag gemini" [ngClass]="getSentimentClass(comment.gemini_sentiment)">
                Gemini: {{ comment.gemini_sentiment }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
